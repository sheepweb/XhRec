<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
          rel="stylesheet">
    <title>任务状态监控</title>
    <style>
        :root {
            --bg-color-light: #ffffff;
            --text-color-light: #000000;
            --bg-color-dark: #121212;
            --text-color-dark: #eeeeee;
            --table-border: #444;
            --highlight-blue: #007bff;
            --highlight-green: #28a745;
            --highlight-orange: orange;
            --highlight-red: red;
            --highlight-yellow: gold;
        }

        span {

            font-family: "JetBrains Mono", monospace;
            font-weight: 500;
            font-style: normal;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--bg-color-dark);
                color: var(--text-color-dark);
            }

            table {
                border-color: var(--table-border);
            }
        }

        @media (prefers-color-scheme: light) {
            body {
                background-color: var(--bg-color-light);
                color: var(--text-color-light);
            }

            table {
                border-color: var(--table-border);
            }
        }

        body {
            font-family: sans-serif;
            padding: 20px;
        }

        h1,
        h2 {
            color: var(--highlight-blue);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        th,
        td {
            border: 1px solid var(--table-border);
            padding: 8px 12px;
            text-align: left;
        }

        th {
            background-color: #33333333;
        }

        tr:nth-child(even) {
            background-color: #00000022;
        }

        .proxy {
            color: var(--highlight-yellow);
        }

        .time-short {
            color: var(--highlight-green);
        }

        .time-medium {
            color: var(--highlight-orange);
        }

        .time-long {
            color: var(--highlight-red);
            font-weight: bold;
        }

        .url-list {
            margin-top: 20px;
            overflow-x: scroll;
        }

        .url-item {
            white-space: nowrap;
            font-size: 0.7em;
            margin-bottom: 4px;
        }

        iframe {
            width: 100%;
            min-height: 70vh;
        }

        .abnormal {
            background: #ffff004f;
        }
    </style>
</head>
<body>
<h1>下载任务状态</h1>
<table id="summary-table">
    <thead>
    <tr>
        <th>任务名</th>
        <th>Total</th>
        <th>Compelete</th>
        <th>Failed</th>
        <th>Bytes</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<!--        <details><iframe src="/preview"></iframe></details>-->
<div class="url-list">
    <h2>当前下载中的 URL 列表</h2>
    <div id="url-items">加载中...</div>
</div>

<script>
    function formatBytes(bytes) {
        const units = ["B", "KB", "MB", "GB"];
        let i = 0;
        while (bytes >= 1024 && i < units.length - 1) {
            bytes /= 1024;
            i++;
        }
        return `${bytes.toFixed(3)} ${units[i]}`;
    }

    async function fetchStatus() {
        try {
            // REPLACE TO YOUR OWN API SERVER
            // REPLACE TO YOUR OWN API SERVER
            // REPLACE TO YOUR OWN API SERVER
            // REPLACE TO YOUR OWN API SERVER
            // REPLACE TO YOUR OWN API SERVER
            // REPLACE TO YOUR OWN API SERVER
            const res = await fetch("/status");
            const data = await res.json();

            const tableBody = document.querySelector(
                "#summary-table tbody"
            );
            const urlContainer = document.getElementById("url-items");
            const now = Date.now();

            tableBody.innerHTML = "";
            urlContainer.innerHTML = "";

            const allUrls = [];
            const MAXLEN = 20;
            let allBytes = 0;
            Object.entries(data).forEach(([taskName, taskInfo]) => {
                if (taskInfo.bytesWrite < 0)
                    taskInfo.bytesWrite += 2147483647 * 2;
                allBytes += taskInfo.bytesWrite;
                const row = document.createElement("tr");
                const compelete = taskInfo.success + taskInfo.failed;
                const normal_rate =
                    (taskInfo.success * 100.0) / taskInfo.total;
                row.innerHTML = `
            <td>${taskName.slice(0, MAXLEN)}</td>
			<td>[${taskInfo.total - compelete}] ${compelete}/${taskInfo.total}</td>
			<td class="${normal_rate < 98 ? "abnormal" : ""}">${
                    taskInfo.success
                } (${normal_rate.toFixed(2)}%)</td>
            <td>${taskInfo.failed}</td>
            <td>${formatBytes(taskInfo.bytesWrite || 0)}</td>
          `;
                tableBody.appendChild(row);
                const running = taskInfo.running || {};

                const entries = Object.entries(running)
                    .map(([url, meta]) => {
                        match = /_(\d+)_part.\.mp4/.exec(url)
                        meta.startAtAbs = match && match.length > 1 && match[1] ? match[1] * 1000 : 0
                        return [url, meta]
                    })
                entries.forEach(([url, meta]) => {
                    const elapsed = (
                        (now - meta.startAt) /
                        1000
                    ).toFixed(1);

                    const elapsedAbs = (
                        (now - meta.startAtAbs) /
                        1000
                    ).toFixed(1);
                    let timeClass = "time-short";
                    if (elapsedAbs > 10) {
                        timeClass = "time-long";
                    } else if (elapsedAbs > 5) {
                        timeClass = "time-medium";
                    }

                    const urlDiv = document.createElement("div");
                    urlDiv.className = "url-item";
                    if (meta.type === "PROXY")
                        urlDiv.classList.add("proxy");
                    urlDiv.innerHTML = `${(taskName + "                                ").slice(0, MAXLEN).replaceAll(" ", "&ensp;")} [${
                        meta.type
                    }] <span class="${timeClass}">[SERVER]:${elapsedAbs}s [DOWNLOADER]${elapsed}s</span> ${
                        url
                    }`;
                    allUrls.push({meta: meta, el: urlDiv});
                });
            });

            const row = document.createElement("tr");
            row.innerHTML = `
	    <td>${Object.keys(data).length}个任务</td>
			<td></td>
			<td></td>
            <td></td>
            <td>${formatBytes(allBytes || 0)}</td>
          `;
            tableBody.appendChild(row);
            if (allUrls.length > 0) {
                allUrls.sort((a, b) => {
                    let offseta = 0;
                    let offsetb = 0;
                    if (
                        a.meta.type == "PROXY"
                    )
                        offseta = -15000;
                    if (
                        b.meta.type == "PROXY"
                    )
                        offsetb = -15000;
                    //console.log(a.meta.type)
                    return a.meta.startAt + offseta - b.meta.startAt - offsetb;
                });
                allUrls.forEach((div) =>
                    urlContainer.appendChild(div.el)
                );
            } else {
                urlContainer.textContent = "无下载任务";
            }
        } catch (e) {
            document.getElementById("url-items").textContent =
                "获取失败: " + e;
        }
    }

    fetchStatus();
    setInterval(fetchStatus, 500);
</script>
</body>
</html>
