<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
          rel="stylesheet">
    <title>任务状态监控</title>
    <style>
        :root {
            --bg-color-light: #ffffff;
            --text-color-light: #000000;
            --bg-color-dark: #121212;
            --text-color-dark: #eeeeee;
            --table-border: #444;
            --highlight-blue: #007bff;
            --highlight-green: #28a745;
            --highlight-orange: orange;
            --highlight-red: red;
            --highlight-yellow: gold;
        }

        span {

            font-family: "JetBrains Mono", monospace;
            font-weight: 500;
            font-style: normal;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--bg-color-dark);
                color: var(--text-color-dark);
            }

            table {
                border-color: var(--table-border);
            }
        }

        @media (prefers-color-scheme: light) {
            body {
                background-color: var(--bg-color-light);
                color: var(--text-color-light);
            }

            table {
                border-color: var(--table-border);
            }
        }

        body {
            font-family: sans-serif;
            padding: 20px;
        }

        h1,
        h2 {
            color: var(--highlight-blue);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        th,
        td {
            border: 1px solid var(--table-border);
            padding: 8px 12px;
            text-align: left;
        }

        th {
            background-color: #33333333;
        }

        tr:nth-child(even) {
            background-color: #00000022;
        }

        .proxy {
            color: var(--highlight-yellow);
        }

        .time-short {
            color: var(--highlight-green);
        }

        .time-medium {
            color: var(--highlight-orange);
        }

        .time-long {
            color: var(--highlight-red);
            font-weight: bold;
        }

        .url-list {
            margin-top: 20px;
        }

        .url-item {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        iframe {
            width: 100%;
            min-height: 70vh;
        }

        .abnormal {
            background: #ffff004f;
        }

        /* 控制面板样式 */
        .control-panel {
            background: #f8f9fa;
            border: 1px solid var(--table-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        @media (prefers-color-scheme: dark) {
            .control-panel {
                background: #2d2d2d;
            }
        }

        .control-section {
            margin-bottom: 15px;
        }

        .control-section h3 {
            margin: 0 0 10px 0;
            color: var(--highlight-blue);
            font-size: 1.1rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--highlight-blue);
            color: white;
        }

        .btn-success {
            background: var(--highlight-green);
            color: white;
        }

        .btn-warning {
            background: var(--highlight-orange);
            color: white;
        }

        .btn-danger {
            background: var(--highlight-red);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .form-input {
            padding: 6px 10px;
            border: 1px solid var(--table-border);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-color-light);
            color: var(--text-color-light);
        }

        @media (prefers-color-scheme: dark) {
            .form-input {
                background: var(--bg-color-dark);
                color: var(--text-color-dark);
            }
        }

        .form-select {
            padding: 6px 10px;
            border: 1px solid var(--table-border);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-color-light);
            color: var(--text-color-light);
        }

        @media (prefers-color-scheme: dark) {
            .form-select {
                background: var(--bg-color-dark);
                color: var(--text-color-dark);
            }
        }

        /* 任务表格操作按钮 */
        .task-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .task-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Toast 通知样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: toast-slide-in 0.3s ease-out;
        }

        .toast.success {
            background: var(--highlight-green);
        }

        .toast.error {
            background: var(--highlight-red);
        }

        .toast.warning {
            background: var(--highlight-orange);
        }

        @keyframes toast-slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toast-slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* 状态指示器 */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active {
            background: var(--highlight-green);
        }

        .status-inactive {
            background: #ccc;
        }

        .status-recording {
            background: var(--highlight-red);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
<h1>XhRec 任务监控与控制</h1>

<!-- 控制面板 -->
<div class="control-panel">
    <div class="control-section">
        <h3>全局控制</h3>
        <div class="button-group">
            <button id="start-scheduler" class="btn btn-success">启动调度器</button>
            <button id="stop-scheduler" class="btn btn-warning">停止调度器</button>
            <button id="stop-server" class="btn btn-danger">停止服务器</button>
            <button id="refresh-status" class="btn btn-secondary">刷新状态</button>
        </div>
    </div>

    <div class="control-section">
        <h3>添加任务</h3>
        <div class="button-group">
            <div class="input-group">
                <input type="text" id="task-url" class="form-input" placeholder="输入房间URL或名称" style="width: 300px;">
                <select id="task-quality" class="form-select">
                    <option value="720p">720p</option>
                    <option value="1080p60">1080p60</option>
                    <option value="720p60">720p60</option>
                    <option value="480p">480p</option>
                    <option value="240p">240p</option>
                    <option value="160p">160p</option>
                    <option value="raw">Raw</option>
                </select>
                <button id="add-task" class="btn btn-primary">添加任务</button>
                <button id="add-task-active" class="btn btn-success">添加并激活</button>
            </div>
        </div>
    </div>
</div>
<table id="summary-table">
    <thead>
    <tr>
        <th>状态</th>
        <th>任务名</th>
        <th>Total</th>
        <th>Complete</th>
        <th>Failed</th>
        <th>Bytes</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- 任务列表表格 -->
<div style="margin-bottom: 20px;">
    <h2>任务列表</h2>
    <table id="task-list-table">
        <thead>
        <tr>
            <th>状态</th>
            <th>任务名</th>
            <th>ID</th>
            <th>质量</th>
            <th>监听</th>
            <th>录制</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<!--        <details><iframe src="/preview"></iframe></details>-->
<div class="url-list">
    <h2>当前下载中的 URL 列表</h2>
    <div id="url-items">加载中...</div>
</div>

<script>
    // 工具函数
    function formatBytes(bytes) {
        const units = ["B", "KB", "MB", "GB"];
        let i = 0;
        while (bytes >= 1024 && i < units.length - 1) {
            bytes /= 1024;
            i++;
        }
        return `${bytes.toFixed(3)} ${units[i]}`;
    }

    // Toast 通知函数
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'toast-slide-out 0.3s ease-in';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // API 调用函数
    async function apiCall(endpoint, params = {}) {
        try {
            const url = new URL(endpoint, window.location.origin);
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined) {
                    url.searchParams.append(key, params[key]);
                }
            });

            const response = await fetch(url);
            const text = await response.text();

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${text}`);
            }

            try {
                return JSON.parse(text);
            } catch {
                return text;
            }
        } catch (error) {
            showToast(`API调用失败: ${error.message}`, 'error');
            throw error;
        }
    }

    // 全局变量
    let taskListData = [];
    let statusData = {};

    // 获取任务列表
    async function fetchTaskList() {
        try {
            taskListData = await apiCall('/list');
            updateTaskListTable();
        } catch (error) {
            console.error('获取任务列表失败:', error);
        }
    }

    // 更新任务列表表格
    function updateTaskListTable() {
        const tableBody = document.querySelector('#task-list-table tbody');
        tableBody.innerHTML = '';

        taskListData.forEach(task => {
            const [isOpen, listening, recording, name, id, quality] = task;
            const row = document.createElement('tr');

            const statusIndicator = isOpen === '[*]' ?
                '<span class="status-indicator status-active"></span>在线' :
                '<span class="status-indicator status-inactive"></span>离线';

            const recordingStatus = recording === 'recording' ?
                '<span class="status-indicator status-recording"></span>录制中' :
                '<span class="status-indicator status-inactive"></span>未录制';

            row.innerHTML = `
                <td>${statusIndicator}</td>
                <td>${name}</td>
                <td>${id}</td>
                <td>${quality}</td>
                <td>${listening === 'listening' ? '是' : '否'}</td>
                <td>${recordingStatus}</td>
                <td>
                    <div class="task-actions">
                        <button class="btn btn-success" onclick="activateTask('${name}')">激活</button>
                        <button class="btn btn-warning" onclick="deactivateTask('${name}')">停用</button>
                        <button class="btn btn-secondary" onclick="breakTask('${name}')">暂停</button>
                        <button class="btn btn-danger" onclick="removeTask('${name}')">移除</button>
                        <select onchange="changeQuality('${name}', this.value)" class="form-select">
                            <option value="">改质量</option>
                            <option value="raw">Raw</option>
                            <option value="1080p60">1080p60</option>
                            <option value="720p60">720p60</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                            <option value="240p">240p</option>
                            <option value="160p">160p</option>
                        </select>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    async function fetchStatus() {
        try {
            statusData = await apiCall('/status');

            const tableBody = document.querySelector("#summary-table tbody");
            const urlContainer = document.getElementById("url-items");
            const now = Date.now();

            tableBody.innerHTML = "";
            urlContainer.innerHTML = "";

            const allUrls = [];
            const MAXLEN = 20;
            let allBytes = 0;

            Object.entries(statusData).forEach(([taskName, taskInfo]) => {
                if (taskInfo.bytesWrite < 0)
                    taskInfo.bytesWrite += 2147483647 * 2;
                allBytes += taskInfo.bytesWrite;

                const row = document.createElement("tr");
                const complete = taskInfo.success + taskInfo.failed;
                const normal_rate = (taskInfo.success * 100.0) / taskInfo.total;

                // 查找对应的任务状态
                const taskStatus = taskListData.find(task => task[3] === taskName);
                const isRecording = taskStatus && taskStatus[2] === 'recording';
                const isOnline = taskStatus && taskStatus[0] === '[*]';

                const statusIndicator = isRecording ?
                    '<span class="status-indicator status-recording"></span>录制中' :
                    isOnline ? '<span class="status-indicator status-active"></span>在线' :
                    '<span class="status-indicator status-inactive"></span>离线';

                row.innerHTML = `
                    <td>${statusIndicator}</td>
                    <td>${taskName.slice(0, MAXLEN)}</td>
                    <td>[${taskInfo.total - complete}] ${complete}/${taskInfo.total}</td>
                    <td class="${normal_rate < 98 ? "abnormal" : ""}">${taskInfo.success} (${normal_rate.toFixed(2)}%)</td>
                    <td>${taskInfo.failed}</td>
                    <td>${formatBytes(taskInfo.bytesWrite || 0)}</td>
                    <td>
                        <div class="task-actions">
                            <button class="btn btn-secondary" onclick="breakTask('${taskName}')">暂停</button>
                            <button class="btn btn-warning" onclick="deactivateTask('${taskName}')">停用</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
                const running = taskInfo.running || {};

                const entries = Object.entries(running)
                    .map(([url, meta]) => {
                        match = /_(\d+)_part.\.mp4/.exec(url)
                        meta.startAtAbs = match && match.length > 1 && match[1] ? match[1] * 1000 : 0
                        return [url, meta]
                    })
                entries.forEach(([url, meta]) => {
                    const elapsed = (
                        (now - meta.startAt) /
                        1000
                    ).toFixed(1);

                    const elapsedAbs = (
                        (now - meta.startAtAbs) /
                        1000
                    ).toFixed(1);
                    let timeClass = "time-short";
                    if (elapsedAbs > 10) {
                        timeClass = "time-long";
                    } else if (elapsedAbs > 5) {
                        timeClass = "time-medium";
                    }

                    const urlDiv = document.createElement("div");
                    urlDiv.className = "url-item";
                    if (meta.type === "PROXY")
                        urlDiv.classList.add("proxy");
                    urlDiv.innerHTML = `${(taskName + "                                ").slice(0, MAXLEN).replaceAll(" ", "&ensp;")} [${
                        meta.type
                    }] <span class="${timeClass}">[SERVER]:${elapsedAbs}s [DOWNLOADER]${elapsed}s</span> ${
                        url.split("/").slice(-1)[0]
                    }`;
                    allUrls.push({meta: meta, el: urlDiv});
                });
            });

            // 添加汇总行
            const summaryRow = document.createElement("tr");
            summaryRow.innerHTML = `
                <td><strong>汇总</strong></td>
                <td><strong>${Object.keys(statusData).length}个任务</strong></td>
                <td></td>
                <td></td>
                <td></td>
                <td><strong>${formatBytes(allBytes || 0)}</strong></td>
                <td></td>
            `;
            tableBody.appendChild(summaryRow);
            if (allUrls.length > 0) {
                allUrls.sort((a, b) => {
                    let offseta = 0;
                    let offsetb = 0;
                    if (
                        a.meta.type == "PROXY"
                    )
                        offseta = -15000;
                    if (
                        b.meta.type == "PROXY"
                    )
                        offsetb = -15000;
                    //console.log(a.meta.type)
                    return a.meta.startAt + offseta - b.meta.startAt - offsetb;
                });
                allUrls.forEach((div) =>
                    urlContainer.appendChild(div.el)
                );
            } else {
                urlContainer.textContent = "无下载任务";
            }
        } catch (e) {
            document.getElementById("url-items").textContent = "获取失败: " + e;
            showToast(`获取状态失败: ${e.message}`, 'error');
        }
    }

    // 控制函数
    async function startScheduler() {
        try {
            await apiCall('/start');
            showToast('调度器已启动', 'success');
        } catch (error) {
            console.error('启动调度器失败:', error);
        }
    }

    async function stopScheduler() {
        try {
            await apiCall('/stop');
            showToast('调度器已停止', 'warning');
        } catch (error) {
            console.error('停止调度器失败:', error);
        }
    }

    async function stopServer() {
        if (!confirm('确定要停止服务器吗？这将终止所有录制任务。')) {
            return;
        }
        try {
            await apiCall('/stop-server');
            showToast('服务器正在停止...', 'warning');
        } catch (error) {
            console.error('停止服务器失败:', error);
        }
    }

    async function addTask(active = false) {
        const urlInput = document.getElementById('task-url');
        const qualitySelect = document.getElementById('task-quality');

        const url = urlInput.value.trim();
        const quality = qualitySelect.value;

        if (!url) {
            showToast('请输入房间URL或名称', 'warning');
            return;
        }

        // 提取slug
        let slug = url;
        if (url.includes('xhamsterlive.com/')) {
            slug = url.split('/').pop().split('#')[0].split('?')[0];
        }

        try {
            await apiCall('/add', { slug, quality, active });
            showToast(`任务已添加: ${slug}`, 'success');
            urlInput.value = '';
            fetchTaskList(); // 刷新任务列表
        } catch (error) {
            console.error('添加任务失败:', error);
        }
    }

    async function removeTask(slug) {
        if (!confirm(`确定要移除任务 "${slug}" 吗？`)) {
            return;
        }
        try {
            await apiCall('/remove', { slug });
            showToast(`任务已移除: ${slug}`, 'success');
            fetchTaskList();
        } catch (error) {
            console.error('移除任务失败:', error);
        }
    }

    async function activateTask(slug) {
        try {
            await apiCall('/activate', { slug });
            showToast(`任务已激活: ${slug}`, 'success');
            fetchTaskList();
        } catch (error) {
            console.error('激活任务失败:', error);
        }
    }

    async function deactivateTask(slug) {
        try {
            await apiCall('/deactivate', { slug });
            showToast(`任务已停用: ${slug}`, 'warning');
            fetchTaskList();
        } catch (error) {
            console.error('停用任务失败:', error);
        }
    }

    async function breakTask(slug) {
        try {
            await apiCall('/break', { slug });
            showToast(`任务已暂停: ${slug}`, 'warning');
        } catch (error) {
            console.error('暂停任务失败:', error);
        }
    }

    async function changeQuality(slug, quality) {
        if (!quality) return;
        try {
            const result = await apiCall('/quality', { slug, quality });
            if (typeof result === 'object' && result.name) {
                showToast(`${result.name} 质量已改为 ${result.quality}`, 'success');
            } else {
                showToast(`质量已更改: ${slug} => ${quality}`, 'success');
            }
            fetchTaskList();
        } catch (error) {
            console.error('更改质量失败:', error);
        }
    }

    // 刷新所有数据
    async function refreshAll() {
        await Promise.all([fetchStatus(), fetchTaskList()]);
        showToast('数据已刷新', 'success');
    }

    // 事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        // 全局控制按钮
        document.getElementById('start-scheduler').addEventListener('click', startScheduler);
        document.getElementById('stop-scheduler').addEventListener('click', stopScheduler);
        document.getElementById('stop-server').addEventListener('click', stopServer);
        document.getElementById('refresh-status').addEventListener('click', refreshAll);

        // 添加任务按钮
        document.getElementById('add-task').addEventListener('click', () => addTask(false));
        document.getElementById('add-task-active').addEventListener('click', () => addTask(true));

        // 回车键添加任务
        document.getElementById('task-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask(false);
            }
        });

        // 初始化数据
        refreshAll();

        // 定时刷新
        setInterval(() => {
            fetchStatus();
            fetchTaskList();
        }, 2000);
    });
</script>
</body>
</html>
