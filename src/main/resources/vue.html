<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
        rel="stylesheet">
    <title>XhRec</title>
</head>
<style>
    :root {
        --bg-color-light: #ffffff;
        --text-color-light: #000000;
        --bg-color-dark: #121212;
        --text-color-dark: #eeeeee;
        --table-border: #444;
        --highlight-blue: #007bff;
        --highlight-green: #28a745;
        --highlight-orange: orange;
        --highlight-red: red;
        --highlight-yellow: gold;
    }

    .url-list {
        margin-top: 20px;
        overflow-x: scroll;
    }

    .url-item {
        font-family: "JetBrains Mono", monospace;
        font-style: normal;
        font-size: .9em;
        margin-bottom: 4px;
    }

    .url-item span {
        font-weight: 600;
    }

    table,
    table tr th,
    table tr td {
        border: 1px solid #00000056;
        padding: .4em;
    }

    button {
        --color-hover: 230, 230, 230;
        --color: 170, 170, 170;
        color: rgb(var(--color), 1);
        /* color: rgb(0, 0, 0); */
        /* padding: 4px; */
        /* margin: 2px; */
        text-shadow: 2px 2px 4px #00000023;
        transition: all .2s;
        display: inline-flex;
        justify-content: center;
        align-items: center;
    }

    button:hover {
        color: rgb(var(--color-hover), 1);
        cursor: pointer;
    }

    .btn-green {
        /* color: rgb(255, 255, 255); */
        /* background-color: rgb(82, 122, 77); */
        --color-hover: 46, 199, 26;
        --color: 40, 100, 12;
    }

    .btn-red {
        /* color: rgb(255, 255, 255); */
        /* background-color: rgb(209, 43, 43); */
        --color-hover: 209, 43, 43;
        --color: 136, 52, 52;
    }

    .btn-blue {
        /* color: rgb(255, 255, 255); */
        /* color: rgb(26, 78, 128); */
        --color-hover: 58, 148, 233;
        --color: 26, 78, 128;
    }

    .time-short {
        color: var(--highlight-green);
    }

    .time-medium {
        color: var(--highlight-orange);
    }

    .time-long {
        color: var(--highlight-red);
        font-weight: bold;
    }

    /* Tooltip 容器 */
    .tooltip {
        position: relative;
        /* display: inline-block; */
        /* 悬停元素上显示点线 */
    }

    /* Tooltip 文本 */
    .tooltip .tooltiptext {
        visibility: hidden;
        text-wrap: nowrap;
        /* width: 120px; */
        background-color: rgb(0, 0, 0);
        color: #fff;
        text-align: center;
        padding: 0px 3px;
        border-radius: 6px;

        /* 定位 */
        left: 0%;
        transform: translateX(-50%);
        bottom: calc(-100% + 8px);
        position: absolute;
        z-index: 1;
    }

    /* 鼠标移动上去后显示提示框 */
    .tooltip:hover .tooltiptext {
        visibility: visible;
    }

    @keyframes download {
        0% {
            opacity: 0;
            transform: translateY(-50%);
        }

        70% {
            opacity: 1;
            transform: translateY(0);
        }

        100% {
            opacity: 0;
            transform: translateY(50%);
        }
    }

    .downloadAnimation {
        animation: download .4s cubic-bezier(0.002, 0.569, 0.716, 0.997) infinite forwards;
    }

    @keyframes toast-slide-in {
        from {
            transform: translateY(100%);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes toast-slide-out {
        from {
            transform: translateY(0);
            opacity: 1;
        }

        to {
            transform: translateY(-100%);
            opacity: 0;
        }
    }

    #popup {
        height: 50px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
    }
</style>

<script type="importmap">
  {
    "imports": {
      "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
    }
  }
</script>

<script>

    function showToast(message, type = "success") {
        // Create toast element
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.style.cssText = `
        position:absolute;
        top:0px;
        left:0;
        padding: 12px 20px;
        border-radius: 4px;
        background-color: ${type === "error" ? "#d32f2f" : "#4caf50"};
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: toast-slide-in 0.3s ease-out forwards;
    `;

        // Add toast to document
        document.getElementById("popup").appendChild(toast);

        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.style.animation = "toast-slide-out 0.3s ease-out forwards";
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 2000);
    }
</script>

<body class="p-3 flex flex-col justify-center items-center bg-slate-300">
    <div id="popup"></div>
    <div id="app" class="container flex flex-col ">
        <div class="bg-slate-200 rounded-md p-4">
            <div class="row mb-2">
                <div class="input flex gap-2">
                    <label for="new_room" class="text-nowrap">
                        Add room
                    </label>
                    <div class="w-full flex justify-center items-center text-gray-600 bg-slate-300 rounded-md px-2">
                        <input v-model="addInput" class="outline-none w-full" type="text" name="" id="new_room">
                        <i class="fa fa-times text-gray-600" aria-hidden="true"></i>
                    </div>
                    <select v-model="addQuality" name="quality" id="quality">
                        <option>160p</option>
                        <option>240p</option>
                        <option>480p</option>
                        <option>720p</option>
                        <option>720p60</option>
                        <option>1080p</option>
                        <option>1080p60</option>
                        <option>2560p60</option>
                    </select>
                    <button @click="addRoom(true)" class="btn-green size-7 tooltip"><i class="fa fa-paper-plane "
                            aria-hidden="true"></i><span class="tooltiptext">Add and active</span></button>
                    <button @click="addRoom(false)" class="btn-green size-7 tooltip"><i class="fa fa-plus"
                            aria-hidden="true"></i><span class="tooltiptext">Add</span></button>

                </div>
            </div>
            <table class="border w-full">
                <thead class="font-bold">
                    <tr>
                        <td class="hover:cursor-pointer" @click="sortToggle('Room')">Room
                            <span class="select-none" v-if="sort['Room']==1">↓</span>
                            <span class="select-none" v-if="sort['Room']==2">↑</span>
                        </td>
                        <td class="hover:cursor-pointer" @click="sortToggle('ID')">ID
                            <span class="select-none" v-if="sort['ID']==1">↓</span>
                            <span class="select-none" v-if="sort['ID']==2">↑</span>
                        </td>
                        <td class="hover:cursor-pointer" @click="sortToggle('Quality')">Quality
                            <span class="select-none" v-if="sort['Quality']==1">↓</span>
                            <span class="select-none" v-if="sort['Quality']==2">↑</span>
                        </td>
                        <td class="hover:cursor-pointer" @click="sortToggle('Status')">Status
                            <span class="select-none" v-if="sort['Status']==1">↓</span>
                            <span class="select-none" v-if="sort['Status']==2">↑</span>
                        </td>
                        <td>Segments status</td>
                        <td class="hover:cursor-pointer" @click="sortToggle('Size')">File
                            size({{formatBytes(Object.values(this.roomDisplay).reduce((a, b) => {
                            return a + (b.bytesWrite||0)
                            }, 0))}})
                            <span class="select-none" v-if="sort['Size']==1">↓</span>
                            <span class="select-none" v-if="sort['Size']==2">↑</span>
                        </td>
                        <td>Control</td>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="room of roomDisplay">
                        <td>{{room.name}}</td>
                        <td>{{room.id}}</td>
                        <td>{{room.quality}}</td>
                        <td>{{room.status}}</td>
                        <td>
                            <span class="text-green-800 mr-1"><i class="fa-solid fa-arrow-down"
                                    :class="{downloadAnimation:room.running}"></i>{{room.running}}</span>
                            <span class="text-red-800  mr-1"><i
                                    class="fa-solid fa-exclamation"></i>{{room.failed}}</span>
                            <span class="text-blue-800 mr-1"><i class="fa-solid fa-check"></i>{{room.success}}</span>
                            <!-- / {{room.total}} -->
                        </td>
                        <td>{{formatBytes(room.bytesWrite)}}</td>
                        <td>
                            <div class="flex flex-nowrap border-none">
                                <button @click="action('activate',room.name)" class="btn-green size-7 tooltip"><i
                                        class="fa fa-play" aria-hidden="true"></i><span
                                        class="tooltiptext">Activate</span></button>
                                <button @click="action('deactivate',room.name)" class="btn-red   size-7  tooltip"><i
                                        class="fa fa-stop" aria-hidden="true"></i><span
                                        class="tooltiptext">Deactivate</span></button>
                                <button @click="setQuality(addQuality,room.name)" class="btn-blue  size-7 tooltip"><i
                                        class="fa fa-gear" aria-hidden="true"></i><span class="tooltiptext">Set
                                        quality to {{addQuality}}</span></button>
                                <button @click="action('break',room.name)" class="btn-blue  size-7 tooltip"><i
                                        class="fa-solid fa-floppy-disk"></i><span class="tooltiptext">Save and start new
                                        recording</span></button>
                                <button @click="action('remove',room.name)" class="btn-red   size-7  tooltip"><i
                                        class="fa fa-trash" aria-hidden="true"></i><span
                                        class="tooltiptext">Remove</span></button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="url-list overflow-x-scroll">
            <div id="url-items" class="text-nowrap">
                <pre v-for="info of allUrls"
                    class="url-item">{{info.prefix}}[{{info.type}}] <span :class="[info.timeClass]">[SERVER]:{{info.elapsedAbs}}[DOWNLOADER]{{info.elapsed}}</span> {{info.url}}</pre>
            </div>
        </div>
    </div>
    <script type="module">
        const HOST = ""
        import { createApp } from 'vue'

        createApp({
            data() {
                return {
                    addInput: "",
                    addQuality: "720p",
                    sort: { "Room": 1 },
                    roomInfo: {},
                    allurls: [],
                }
            },
            methods: {
                sortToggle(by) {
                    if (this.sort[by]) {
                        this.sort[by] = this.sort[by] == 1 ? 2 : undefined
                    } else {
                        this.sort[by] = 1
                    }
                },
                formatBytes(bytes) {
                    if (!bytes) {
                        return ``
                    }
                    const units = ["B", "KB", "MB", "GB"];
                    let i = 0;
                    while (bytes >= 1024 && i < units.length - 1) {
                        bytes /= 1024;
                        i++;
                    }
                    return `${bytes.toFixed(3)} ${units[i]}`;
                },
                async setQuality(quality, roomName) {
                    const r1 = await fetch(`${HOST}/quality?slug=${roomName}&quality=${quality}`)
                    const data1 = await r1.text()
                    showToast(data1)
                },
                async action(action, roomName) {
                    const r1 = await fetch(`${HOST}/${action}?slug=${roomName}`)
                    const data1 = await r1.text()
                    showToast(data1)
                },
                async addRoom(active) {
                    const name = this.addInput.split("/").slice(-1)[0].split("?")[0]
                    const r1 = await fetch(`${HOST}/add?slug=${name}&active=${active}&quality=&${this.addQuality}`)
                    const data1 = await r1.text()
                    if (r1.status == 404 || r1.status == 200) {
                        showToast("OK")
                        this.addInput = ""
                    } else {
                        showToast(data1)
                    }
                },
                async fetchdata() {

                    const r1 = await fetch(`${HOST}/recorders`)
                    const data1 = await r1.json()
                    const r2 = await fetch(`${HOST}/status`)
                    const data2 = await r2.json()
                    const r3 = await fetch(`${HOST}/list`)
                    const data3 = await r3.json()
                    this.roomInfo = {}
                    for (const room of data1) {
                        this.roomInfo[room.name] = room
                    }
                    this.allUrls = []
                    const MAXLEN = 20;
                    const now = Date.now();
                    for (const roomName in data2) {
                        const element = data2[roomName];
                        this.roomInfo[roomName] = {
                            ...this.roomInfo[roomName],
                            total: element.total,
                            success: element.success,
                            bytesWrite: element.bytesWrite,
                            failed: element.failed,
                            running: Object.keys(element.running).length,
                        }
                        const entries = Object.entries(element.running)
                            .map(([url, meta]) => {
                                let match = /_(\d+)_part.\.mp4/.exec(url)
                                if (!match) {
                                    return [url, meta]
                                }
                                meta.startAtAbs = match && match.length > 1 && match[1] ? match[1] * 1000 : 0
                                return [url, meta]
                            })
                        entries.forEach(([url, meta]) => {
                            const elapsed = (
                                (now - meta.startAt) /
                                1000
                            ).toFixed(1);

                            const elapsedAbs = (
                                (now - meta.startAtAbs) /
                                1000
                            ).toFixed(1);
                            let timeClass = "time-short";
                            if (elapsedAbs > 10) {
                                timeClass = "time-long";
                            } else if (elapsedAbs > 5) {
                                timeClass = "time-medium";
                            }
                            this.allUrls.push({ prefix: (roomName + "                                ").slice(0, MAXLEN), type: meta.type, timeClass, elapsedAbs, elapsed, url });
                        });
                    }
                    for (const room of data3) {
                        this.roomInfo[(room[3])] = {
                            ...this.roomInfo[(room[3])],
                            status: room[0] == "[*]" ? "Recording" : room[1].trim(),
                        }
                    }
                },
            },
            mounted() {
                this.fetchdata()
                setInterval(() => {
                    this.fetchdata()
                }, 500);
            },
            computed: {
                roomDisplay() {
                    const list = Object.values(this.roomInfo)
                    list.sort((a, b) => {
                        if (this.sort["Status"]) {
                            if (a.status == "Recording" && b.status != "Recording") {
                                return this.sort["Status"] == 1 ? -1 : 1
                            }
                            if (a.status != "Recording" && b.status == "Recording") {
                                return this.sort["Status"] == 1 ? 1 : -1
                            }
                            if (a.status == "listening" && b.status != "listening") {
                                return this.sort["Status"] == 1 ? -1 : 1
                            }
                            if (a.status != "listening" && b.status == "listening") {
                                return this.sort["Status"] == 1 ? 1 : -1
                            }
                        }
                        if (this.sort["Quality"]) {
                            const res = parseInt(a.quality.split("p")[0]) - parseInt(b.quality.split("p")[0])
                            return this.sort["Quality"] == 1 ? res : -res
                        }
                        if (this.sort["ID"]) {
                            return this.sort["ID"] == 1 ? a.id - b.id : b.id - a.id
                        }
                        if (this.sort["Size"]) {
                            return this.sort["Size"] == 1 ? (a.bytesWrite || 0) - (b.bytesWrite || 0) : (b.bytesWrite || 0) - (a.bytesWrite || 0)
                        }
                        if (this.sort["Room"]) {
                            return this.sort["Room"] == 1 ? a.name.toLowerCase().localeCompare(b.name.toLowerCase()) : b.name.toLowerCase().localeCompare(a.name.toLowerCase())
                        }
                        return 0
                    })

                    return list
                }
            }
        }).mount('#app')
    </script>
</body>

</html>